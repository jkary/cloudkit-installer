---
# Main tasks for fulfillment_cli_base role

- name: Create test workspace directory
  ansible.builtin.file:
    path: "{{ testing_workspace }}"
    state: directory
    mode: '0755'
  tags:
    - setup
    - workspace

- name: Verify fulfillment-cli binary exists
  ansible.builtin.stat:
    path: "{{ cli_binary }}"
  register: cli_binary_stat
  failed_when: not cli_binary_stat.stat.exists
  tags:
    - validation
    - cli

- name: Verify KUBECONFIG file exists
  ansible.builtin.stat:
     path: "{{ ansible_env.KUBECONFIG }}"
  register: kubeconfig_stat
  failed_when: not kubeconfig_stat.stat.exists
  tags:
    - validation
    - kubeconfig

- name: Test oc CLI connectivity
  ansible.builtin.command:
    cmd: oc whoami
  environment:
    KUBECONFIG: "{{ ansible_env.KUBECONFIG }}"
  register: oc_whoami_result
  changed_when: false
  tags:
    - validation
    - connectivity

- name: Login to fulfillment-cli
  ansible.builtin.command:
    cmd: >
      {{ cli_binary }} login
      --address {{ fulfillment_address }}
      --insecure
      --token-script "{{ fulfillment_token_script }}"
  register: cli_login_result
  tags:
    - setup
    - login

- name: Test fulfillment-cli connectivity after login
  ansible.builtin.command:
    cmd: "{{ cli_binary }} get clustertemplates"
  register: cli_connectivity_test
  changed_when: false
  failed_when: cli_connectivity_test.rc != 0
  tags:
    - validation
    - connectivity

- name: Display fulfillment-cli connectivity status
  ansible.builtin.debug:
    msg: "fulfillment-cli connectivity test successful"
  when: cli_connectivity_test.rc == 0
  tags:
    - info
    - connectivity

- name: Generate access token for gRPC calls
  ansible.builtin.command:
    cmd: "{{ fulfillment_token_script }}"
  environment:
    KUBECONFIG: "{{ ansible_env.KUBECONFIG }}"
  register: grpc_token_result
  changed_when: false
  no_log: false
  when: not ansible_check_mode
  tags:
    - setup
    - token

- name: Set dummy token for check mode
  ansible.builtin.set_fact:
    grpc_token_result:
      stdout: "dummy-token-for-check-mode"
  when: ansible_check_mode
  tags:
    - setup
    - token

- name: Save access token to file
  ansible.builtin.copy:
    content: "{{ grpc_token_result.stdout }}"
    dest: "{{ testing_workspace }}/grpc-token.txt"
    mode: '0600'
  no_log: true
  when: not ansible_check_mode
  tags:
    - setup
    - token

- name: Initialize test execution log
  ansible.builtin.copy:
    content: |
      # CloudKit E2E Test Execution Log
      Started at: {{ ansible_date_time.iso8601 }}
      Test Environment: {{ test_environment }}
      KUBECONFIG: {{ ansible_env.KUBECONFIG }}
      OpenShift User: {{ oc_whoami_result.stdout }}
      
    dest: "{{ testing_workspace }}/test-execution.log"
    mode: '0644'
  tags:
    - setup
    - logging
